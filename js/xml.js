// js/xml.js — v0.9.106 — ПОЛНЫЙ И РАБОЧИЙ

const XML_VERSION = "v0.9.106";
window.XML_VERSION = XML_VERSION;

let xmlFormat = localStorage.getItem('xmlFormat') || 'pretty';

function setXMLFormat(val) {
  xmlFormat = val;
  localStorage.setItem('xmlFormat', val);
}

function generateXML() {
  const eventId = document.getElementById('event-id')?.value.trim() || 'custom_event';

  let xml = `<ScriptedEvent identifier="${eventId}" commonness="100">\n`;

  function walk(container, indent = "  ") {
    container.querySelectorAll(':scope > .node').forEach(node => {
      if (node.classList.contains('spawn')) {
        const item = node.querySelector('.item-field')?.value.trim() || 'revolver';
        xml += `${indent}  <SpawnAction itemidentifier="${item}" targetinventory="player" />\n`;
      } else if (node.classList.contains('rng')) {
        const chance = node.querySelector('.chance')?.value.trim() || '0.5';
        xml += `${indent}  <RNGAction chance="${chance}">\n`;
        xml += `${indent}    <Success>\n`;
        const s = node.querySelector(`#c-${node.dataset.id}-s`);
        if (s) walk(s, indent + "      ");
        xml += `${indent}    </Success>\n`;
        xml += `${indent}    <Failure>\n`;
        const f = node.querySelector(`#c-${node.dataset.id}-f`);
        if (f) walk(f, indent + "      ");
        xml += `${indent}    </Failure>\n`;
        xml += `${indent}  </RNGAction>\n`;
      }
    });
  }

  walk(document.getElementById('root-children'));
  xml += `</ScriptedEvent>`;

  const full = `<Randomevents>\n  <EventPrefabs>\n    ${xml}\n  </EventPrefabs>\n</Randomevents>`;

  let output = full;
  if (xmlFormat === 'minified') {
    output = full.replace(/\n\s*/g, '');
  } else if (xmlFormat === 'comments') {
    output = `<!-- Generated by Barotrauma RNG Builder v0.9.106 -->\n` + full;
  }

  document.getElementById('output').value = output;
}

function copyXML() {
  const text = document.getElementById('output').value;
  if (!text.trim()) {
    alert('Сначала сгенерируйте XML');
    return;
  }
  navigator.clipboard.writeText(text)
    .then(() => alert('XML скопирован в буфер обмена!'))
    .catch(() => alert('Не удалось скопировать'));
}

function downloadXML() {
  const text = document.getElementById('output').value;
  if (!text.trim()) {
    alert('Сначала сгенерируйте XML');
    return;
  }
  const blob = new Blob([text], { type: 'text/xml' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${document.getElementById('event-id')?.value.trim() || 'event'}.xml`;
  a.click();
  URL.revokeObjectURL(url);
}

// Экспорт
window.generateXML = generateXML;
window.copyXML = copyXML;
window.downloadXML = downloadXML;
window.setXMLFormat = setXMLFormat;
