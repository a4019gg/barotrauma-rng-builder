// js/xml.js — v0.9.112 — With Comments + валидация + дубли ID

const XML_VERSION = "v0.9.112";
window.XML_VERSION = XML_VERSION;

let xmlFormat = localStorage.getItem('xmlFormat') || 'pretty';

function setXMLFormat(val) {
  xmlFormat = val;
  localStorage.setItem('xmlFormat', val);
}

function generateXML() {
  const eventId = document.getElementById('event-id')?.value.trim() || 'custom_event';

  let xml = `<ScriptedEvent identifier="${eventId}" commonness="100">`;

  // Добавляем комментарий-водяной знак только если выбран режим
  if (xmlFormat === 'comments') {
    xml += `\n  <!-- Generated by Barotrauma RNG Builder v0.9.112 -->`;
  }

  function walk(container, indent = "  ") {
    container.querySelectorAll(':scope > .node').forEach(node => {
      if (node.classList.contains('spawn')) {
        const item = node.querySelector('.item-field')?.value.trim() || 'revolver';
        const comment = xmlFormat === 'comments' ? ` <!-- ${item} -->` : '';
        xml += `\n${indent}  <SpawnAction itemidentifier="${item}" targetinventory="player" />${comment}`;
      } else if (node.classList.contains('rng')) {
        const chance = node.querySelector('.chance')?.value.trim() || '0.5';
        const comment = xmlFormat === 'comments' ? ` <!-- ${(+chance*100).toFixed(1)}% -->` : '';
        xml += `\n${indent}  <RNGAction chance="${chance}">${comment}`;
        xml += `\n${indent}    <Success>`;
        const s = node.querySelector(`#c-${node.dataset.id}-s`);
        if (s) walk(s, indent + "      ");
        xml += `\n${indent}    </Success>`;
        xml += `\n${indent}    <Failure>`;
        const f = node.querySelector(`#c-${node.dataset.id}-f`);
        if (f) walk(f, indent + "      ");
        xml += `\n${indent}    </Failure>`;
        xml += `\n${indent}  </RNGAction>`;
      }
    });
  }

  walk(document.getElementById('root-children'));
  xml += `\n</ScriptedEvent>`;

  const full = `<Randomevents>\n  <EventPrefabs>\n    ${xml}\n  </EventPrefabs>\n</Randomevents>`;

  let output = full;

  if (xmlFormat === 'minified') {
    output = full.replace(/\n\s*/g, '');
  }

  // ВАЛИДАЦИЯ
  const issues = [];

  if (localStorage.getItem('validateXML') === 'true') {
    if (!xml.includes('<SpawnAction') && !xml.includes('<RNGAction')) {
      issues.push('Событие пустое');
    }
  }

  if (localStorage.getItem('checkDuplicateIDs') === 'true') {
    const ids = new Map();
    const matches = [...xml.matchAll(/identifier="([^"]+)"/g)];
    for (const m of matches) {
      const id = m[1];
      if (ids.has(id)) {
        issues.push(`Дубликат identifier: "${id}"`);
      } else {
        ids.set(id, true);
      }
    }
  }

  if (issues.length > 0) {
    alert('⚠ Внимание!\n\n' + issues.join('\n'));
  }

  document.getElementById('output').value = output;
}
